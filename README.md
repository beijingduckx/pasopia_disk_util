# PASOPIA Disk Utility

PASOPIA/PASOPIA7 (PA7010/PA7007) 用のディスクユーティリティです。

2ドライブ間のコピー, フォーマット, ディスクイメージ書き込み の機能を持ちます。

ディスクイメージ書き込みがメインの機能でしたが、ついでに機能拡張しました。

## 使い方
1. Windows PCの音声出力とPASOPIAのカセットインターフェース(白:LOAD側)を接続します  
  (カセットインターフェースの白プラグを直接PCに接続するのは避けてください。 
   PCの音声出力のどちらか片方のチャンネルを、PASOPIAに接続します)

1. PASOPIAのディスクドライブ、PASOPIAの電源を入れます
1. PASOPIA7では、'How many disk drives'には 0を指定します
1. BASICのプロンプトで `CLOAD`+<kbd>Return</kbd> を入力します
1. メディアプレイヤーなどで`DiskUtil.wav`を再生します
1. CLOADが終了したら、`RUN`します
1. 画面の表示に従って操作します。メニューからは  
   0: ディスクイメージ書き込み  
   1: コピー  
   2: フォーマット  
   を選択します


[!NOTE]
> - 画面に出る`Track:`番号は論理的なトラック番号で、0はTrack0:Side0, 1は Track0:Side1.. のようになっています
> - PASOPIA7では、念のため、本プログラム実行後は一旦リセットしてください。BIOSが管理しているディスク状態と、実際のドライブの状態がずれるためです



## 制限
- 5インチ2D専用です
- トラック0 サイド0 は処理をしません (128bytes/sector部を避けています)
- 東芝製ドライブ(片面35トラック/両面70トラック)用です
- 2ドライブ必要です
- エラーが発生してもリトライしません
- 全てのコマンドは、ベリファイしません (フォーマット含む)

必要に応じてプログラムを変更すれば、いくつかの制限は回避できると思います。

## ディスクイメージ書き込み
Windowsマシンにあるディスクイメージを、カセットインターフェース経由で PASOPIA に転送して、実ディスクに書き込みます。

完了まで、約40分かかります。

### ディスクイメージ書き込みの操作
1. 上記同様、PCの音声出力とPASOPIAを接続します
1. Disk Utility メニューからディスクイメージ書き込み(0)を選択します
1. イメージを書き込むフォーマット済ディスクをドライブ2にセットします
1. Windows側でPowerShellを起動し、`DiskImageCopy.ps1`があるフォルダに移動します
1. PASOPIA側で `y` + <kbd>Return</kbd> を入力し、`Track: 1`の待機状態とします
1. Windows側で `DiskImageCopy.ps1 [ディスクイメージ]` の形式でコピーツールを起動し、転送を開始します (実際に転送が開始されるまで少しかかります)

この後は、
- Windows側でディスクイメージを BLOAD 音声データに変換して出力
- PASOPIA側でディスクイメージを BLOAD し、ロードが終了したらディスクに書き込み

が69トラックまで繰り返されます。

[!NOTE]
> Windowsの音声出力レベルは、
> - メディアプレイヤー(`DiskUtil.wav`再生)内の音量調整は、最大にしつつ
> - マスターボリュームは 50 (真ん中の位置) 
>
> あたりが良いようですが、環境に応じて調整してください。

[!NOTE]
- PASOPIA側がリードエラーとなった場合は、PC側のプログラムを手動で停止してください (PCとPASOPIAはハンドシェークしていません)

### イメージ書き込みの制限
- 対応しているディスクイメージは、256bytes/sectorのベタイメージのみです (Track0, Side0の全セクタも256bytes/sectorの必要があります)


## 動作確認環境
- ミニフロッピーディスクユニット PA7200
- PASOPIA (PA7010)
- PASOPIA7 (PA7007)

## ソースコードについて
参考のために、Disk I/O部のソースコード、コンパイルスクリプトを添付しています。

## 非保証
本リポジトリ内のプログラムは、正常に動作することを期待して作成していますが、正常な動作を保証しません。  
本リポジトリ内のプログラムを参照・利用したことにより生じた損害に対し、制作者は一切補償しません。  

## 参考文献など
- 東芝パーソナルコンピュータ パソピア7 テクニカルマニュアル
- [パソピアの内部構造](https://dl.ndl.go.jp/pid/12628498/1/76)
- [DumpListEditor](https://bugfire2009.ojaru.jp/input.html)
- [zakさんツール、フォーマット形式](https://PASOPIA700.blogspot.com/2023/02/7700fd.html)
